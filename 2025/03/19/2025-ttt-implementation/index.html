<!DOCTYPE html>
<html lang="en,zh-cn,default">
<head>
  <meta charset="UTF-8">




<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

  <meta name="author" content="陈英发 Yingfa Chen">


  <meta name="subtitle" content="陈英发">


  <meta name="description" content="NLP Ph.D. at Tsinghua University (THUNLP lab), advised by Prof. Zhiyuan Liu. Previously received a Bachelor's and Master's degree at Tsinghua University. Doing research about long-context language models and knowledge updating.

GitHub: chen-yingfa
Discord: blazing1999
">


  <meta name="keywords" content="Chen Yingfa,陈英发,Natural Language Processing,Artificial Intelligence,Large Language Models">


<title>Implementating Test-Time Training - Part 1 | Yingfa Chen</title>



<link rel="icon" href="/images/favicon-32x32.png">


<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css"
/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">


<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/css/search.css">



<script src="/lib/jquery.min.js"></script>


<script src="/lib/iconify-icon.min.js"></script>


<script src="https://cdn.tailwindcss.com?plugins=typography"></script>
<script>
  tailwind.config = {
    darkMode: "class",
  };
</script>

<script>
  (function () {
    const prefersDark =
      window.matchMedia &&
      window.matchMedia("(prefers-color-scheme: dark)").matches;
    const setting = localStorage.getItem("hexo-color-scheme") || "auto";
    if (setting === "dark" || (prefersDark && setting !== "light"))
      document.documentElement.classList.toggle("dark", true);
    let isDark = document.documentElement.classList.contains("dark");
  })();

  $(document).ready(function () {
    // init icon
    const prefersDark =
      window.matchMedia &&
      window.matchMedia("(prefers-color-scheme: dark)").matches;
    const isDark = document.documentElement.classList.contains("dark");
    $("#theme-icon").attr("icon", isDark ? "ic:round-dark-mode" : "ic:round-light-mode");

    function toggleGiscusTheme() {
      const isDark = document.documentElement.classList.contains("dark");
      const giscusFrame = document.querySelector("iframe.giscus-frame");
      if (giscusFrame) {
        giscusFrame.contentWindow.postMessage(
          {
            giscus: {
              setConfig: {
                theme: isDark ? "dark" : "light",
              },
            },
          },
          "https://giscus.app"
        );
      }
    }


    // toggle dark mode
    function toggleDark() {
      let isDark = document.documentElement.classList.contains("dark");
      const setting = localStorage.getItem("hexo-color-scheme") || "auto";
      isDark = !isDark;
      document.documentElement.classList.toggle("dark", isDark);
      $("#theme-icon").attr("icon", isDark ? "ic:round-dark-mode" : "ic:round-light-mode");
      if (prefersDark === isDark) {
        localStorage.setItem("hexo-color-scheme", "auto");
      } else {
        localStorage.setItem("hexo-color-scheme", isDark ? "dark" : "light");
      }
      toggleGiscusTheme();
    }
    $("#toggle-dark").click(toggleDark);

    // listen dark mode change
    window
      .matchMedia("(prefers-color-scheme: dark)")
      .addEventListener("change", (e) => {
        const setting = localStorage.getItem("hexo-color-scheme") || "auto";
        if (setting === "auto") {
          document.documentElement.classList.toggle("dark", e.matches);
          $("#theme-icon").attr(
            "icon",
            e.matches ? "ic:round-dark-mode" : "ic:round-light-mode"
          );
          toggleGiscusTheme();
        }
      });
  });
</script>




<meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>
<body 
  class="
    bg-[var(--c-0)]
    text-[var(--c-80)]
  ">
  <!-- The navigation bar -->
<header class="
    flex flex-row items-center
    w-full
    pr-4
    z-10
    border-b-[1px]
    border-b-[var(--c-border)]
    dark:bg-[var(--c-0)]
    dark:border-b-[var(--c-0)]
    gap-2
    h-[var(--h-header)]
    text-[var(--c-80)]
">
  <!-- Left part -->
  <div class="overflow-hidden h-full flex flex-row items-center">
    <!-- Site Title on the top left -->
    <a href="/" class="
            whitespace-nowrap
            text-2xl
            text-[var(--c-theme)]
            hover:text-[var(--c-theme)]
            pl-4
            font-black
            bg-gradient-to-r from-cyan-500
            to-blue-500 bg-clip-text text-transparent
          ">
      Yingfa Chen
    </a>
  </div>
  <!-- Div for pushing items to both sides -->
  <div class="flex-1"></div>
  <!-- Right part -->
  <div class="flex flex-row items-center z-20 h-full">
    <!-- Page links -->
    <div class="hidden sm:flex flex-row h-full">
      
        
        
          
          
        
      <a href="/./archives" class="
                        flex flex-row items-center
                        gap-1
                        hover:underline
                        hover:bg-[var(--c-20)]
                        hover:text-[var(--c-theme)]
                        transition-all
                        px-2
                        py-1
                        my-1
                        rounded-lg
                        group
                        whitespace-nowrap
                    ">
        
        <iconify-icon class="group-hover:scale-125 transition-transform" icon="mingcute:inbox-fill" width="22">
        </iconify-icon>
        
        
        <p>Posts</p>
        
      </a>
      
        
        
          
          
        
      <a href="/./publications" class="
                        flex flex-row items-center
                        gap-1
                        hover:underline
                        hover:bg-[var(--c-20)]
                        hover:text-[var(--c-theme)]
                        transition-all
                        px-2
                        py-1
                        my-1
                        rounded-lg
                        group
                        whitespace-nowrap
                    ">
        
        <iconify-icon class="group-hover:scale-125 transition-transform" icon="mingcute:science-fill" width="22">
        </iconify-icon>
        
        
        <p>Publications</p>
        
      </a>
      
        
        
          
          
        
      <a href="/./about" class="
                        flex flex-row items-center
                        gap-1
                        hover:underline
                        hover:bg-[var(--c-20)]
                        hover:text-[var(--c-theme)]
                        transition-all
                        px-2
                        py-1
                        my-1
                        rounded-lg
                        group
                        whitespace-nowrap
                    ">
        
        <iconify-icon class="group-hover:scale-125 transition-transform" icon="mingcute:user-info-fill" width="22">
        </iconify-icon>
        
        
        <p>About Me</p>
        
      </a>
      
        
        
          
          
        
      <a href="/./categories" class="
                        flex flex-row items-center
                        gap-1
                        hover:underline
                        hover:bg-[var(--c-20)]
                        hover:text-[var(--c-theme)]
                        transition-all
                        px-2
                        py-1
                        my-1
                        rounded-lg
                        group
                        whitespace-nowrap
                    ">
        
        <iconify-icon class="group-hover:scale-125 transition-transform" icon="mingcute:classify-2-fill" width="22">
        </iconify-icon>
        
        
      </a>
      
        
        
          
          
        
      <a href="/./tags" class="
                        flex flex-row items-center
                        gap-1
                        hover:underline
                        hover:bg-[var(--c-20)]
                        hover:text-[var(--c-theme)]
                        transition-all
                        px-2
                        py-1
                        my-1
                        rounded-lg
                        group
                        whitespace-nowrap
                    ">
        
        <iconify-icon class="group-hover:scale-125 transition-transform" icon="mingcute:tag-fill" width="22">
        </iconify-icon>
        
        
      </a>
      
        
        
          
          
        
      <a href="/./index" class="
                        flex flex-row items-center
                        gap-1
                        hover:underline
                        hover:bg-[var(--c-20)]
                        hover:text-[var(--c-theme)]
                        transition-all
                        px-2
                        py-1
                        my-1
                        rounded-lg
                        group
                        whitespace-nowrap
                    ">
        
        <iconify-icon class="group-hover:scale-125 transition-transform" icon="mingcute:home-2-fill" width="22">
        </iconify-icon>
        
        
      </a>
      
    </div>
    <!-- Icons on the right -->
    <div class="flex flex-row items-center justify-center">

      <!-- TODO: Add search icon here -->

      <!-- Dark/light toggle icon -->
      <a class="flex group p-1" title="toggle theme" id="toggle-dark">
        <iconify-icon class="transition-transform
                    group-hover:rotate-[45deg]
                    group-hover:scale-125
                    group-hover:text-[var(--c-theme)]" width="24" id="theme-icon">
        </iconify-icon>
      </a>
      <!-- Icon for dropout menu on small screens -->
      <div class="flex flex-row items-center justify-center p-1 sm:hidden">
        <a class="w-6 h-6" aria-hidden="true" id="open-menu">
          <iconify-icon width="24" icon="mingcute:menu-fill" class="transition-transform hover:scale-125 hover:rotate-[5deg]">
          </iconify-icon>
        </a>
        <a class="w-6 h-6 hidden" aria-hidden="true" id="close-menu">
          <iconify-icon width="24" icon="mingcute:close-circle-fill" class="transition-transform hover:scale-125 hover:rotate-[80deg]">
          </iconify-icon>
        </a>
      </div>
    </div>
  </div>
</header>

<!-- Dropdown menu on small screens -->
<div id="menu-panel" class="
        h-0
        overflow-hidden
        sm:hidden
        w-full
        z-10
        rounded
    ">
  <div id="menu-content" class="
        flex
        flex-col
        font-bold
        text-xl
        border-b-[1px]
        relative
        z-20
        border-[var(--c-sep)]
        px-2
        py-2
        -translate-y-full
        transition-transform
        duration-200
        ">
    
    
    
    <a href="/./archives" class="
                flex flex-row items-center
                gap-2
                h-12
                hover:underline
                hover:bg-[var(--c-20)]
                px-3
                py-1
                rounded-lg
            ">
      <iconify-icon icon="mingcute:inbox-fill" width="22">
      </iconify-icon>
      <p>
        Posts
      </p>
    </a>
    
    
    
    
    <a href="/./publications" class="
                flex flex-row items-center
                gap-2
                h-12
                hover:underline
                hover:bg-[var(--c-20)]
                px-3
                py-1
                rounded-lg
            ">
      <iconify-icon icon="mingcute:science-fill" width="22">
      </iconify-icon>
      <p>
        Publications
      </p>
    </a>
    
    
    
    
    <a href="/./about" class="
                flex flex-row items-center
                gap-2
                h-12
                hover:underline
                hover:bg-[var(--c-20)]
                px-3
                py-1
                rounded-lg
            ">
      <iconify-icon icon="mingcute:user-info-fill" width="22">
      </iconify-icon>
      <p>
        About Me
      </p>
    </a>
    
    
    
    
    <a href="/./categories" class="
                flex flex-row items-center
                gap-2
                h-12
                hover:underline
                hover:bg-[var(--c-20)]
                px-3
                py-1
                rounded-lg
            ">
      <iconify-icon icon="mingcute:classify-2-fill" width="22">
      </iconify-icon>
      <p>
        Categories
      </p>
    </a>
    
    
    
    
    <a href="/./tags" class="
                flex flex-row items-center
                gap-2
                h-12
                hover:underline
                hover:bg-[var(--c-20)]
                px-3
                py-1
                rounded-lg
            ">
      <iconify-icon icon="mingcute:tag-fill" width="22">
      </iconify-icon>
      <p>
        Tags
      </p>
    </a>
    
    
    
    
    <a href="/./index" class="
                flex flex-row items-center
                gap-2
                h-12
                hover:underline
                hover:bg-[var(--c-20)]
                px-3
                py-1
                rounded-lg
            ">
      <iconify-icon icon="mingcute:home-2-fill" width="22">
      </iconify-icon>
      <p>
        Home
      </p>
    </a>
    
    
  </div>
</div>

  <main>
    <!-- css -->

<link rel="stylesheet" href="/lib/fancybox/fancybox.min.css">

  
<link rel="stylesheet" href="/lib/tocbot/tocbot.min.css">

    <!-- toc -->
    
  <!-- tocbot -->
<nav class="post-toc toc text-sm w-40 relative top-32 right-4 opacity-70 hidden lg:block" style="position: fixed !important;"></nav>


<section class="px-6 max-w-prose mx-auto md:px-0">
  <!-- Post header before content -->
  <header class="py-4">
    <div class="flex flex-col gap-2 pt-4 md:pt-6">
      <!-- Title -->
      <div id="article-title" class="leading-snug">
        <p class="text-3xl font-bold text-[var(--c-100)] mb-4">Implementating Test-Time Training - Part 1</p>
      </div>
      <!-- Meta data -->
      <div>
        <section class="
          flex flex-col gap-x-2 gap-y-1 text-sm text-[var(--c-100)]">
          <div class="flex flex-wrap items-center gap-x-2 gap-y-1">
            <!-- Dates -->
            <div class="flex items-center gap-1">
              <iconify-icon width="18" icon="mingcute:add-circle-fill" ></iconify-icon>
              Created: <time class="w-max">2025-03-19</time>
            </div>
            <div class="flex items-center gap-1">
              <iconify-icon width="18" icon="mingcute:refresh-3-fill" ></iconify-icon>
              Edited: <time class="w-max">2025-03-23</time>
            </div>
          </div>
          <div class="flex flex-wrap items-center gap-x-3 gap-y-3">
            <!-- Author -->
            
              <span class="flex items-center gap-1 group">
                <iconify-icon width="18" icon="mingcute:user-edit-fill" ></iconify-icon>
                <p>陈英发 Yingfa Chen</p>
              </span>
            

            <!-- Word count -->
            <span class="flex items-center gap-1">
              <iconify-icon width="18" icon="mingcute:book-2-fill" ></iconify-icon>
              <span>1.7k words, 10 min</span>
            </span>
            <!-- Categories -->
            
              <!-- <span class="text-gray-400">·</span> -->
              <span class="flex flex-row items-center gap-1 group hover:underline">
                <iconify-icon class="transition-all group-hover:scale-125 mr-0"
                  width="18"
                  icon="mingcute:classify-2-fill">
                </iconify-icon>
                <a class="article-category-link" href="/categories/research/">Research</a>
              </span>
            
          </div>
        </section>
      </div>
      <!-- tags -->
      <div>
        
<div class="flex flex-wrap gap-1">
  
    
      <a href="/tags/language-models/" 
        class="
          tag
          text-sm
          rounded-full
          px-[5px]
          border-[1px]
          border-[var(--c-theme)]
          text-[var(--c-theme)]
          bg-[var(--c-0)]
          dark:bg-[var(--c-0)]
          dark:drop-shadow-none
          hover:bg-[var(--c-theme)]
          hover:text-[var(--c-0)]
          dark:hover:text-[var(--c-10)]
          dark:hover:bg-[var(--c-theme)]
        ">
        language models
      </a>
    
      <a href="/tags/research/" 
        class="
          tag
          text-sm
          rounded-full
          px-[5px]
          border-[1px]
          border-[var(--c-theme)]
          text-[var(--c-theme)]
          bg-[var(--c-0)]
          dark:bg-[var(--c-0)]
          dark:drop-shadow-none
          hover:bg-[var(--c-theme)]
          hover:text-[var(--c-0)]
          dark:hover:text-[var(--c-10)]
          dark:hover:bg-[var(--c-theme)]
        ">
        research
      </a>
    
      <a href="/tags/neural-networks/" 
        class="
          tag
          text-sm
          rounded-full
          px-[5px]
          border-[1px]
          border-[var(--c-theme)]
          text-[var(--c-theme)]
          bg-[var(--c-0)]
          dark:bg-[var(--c-0)]
          dark:drop-shadow-none
          hover:bg-[var(--c-theme)]
          hover:text-[var(--c-0)]
          dark:hover:text-[var(--c-10)]
          dark:hover:bg-[var(--c-theme)]
        ">
        neural-networks
      </a>
    
      <a href="/tags/test-time-learning/" 
        class="
          tag
          text-sm
          rounded-full
          px-[5px]
          border-[1px]
          border-[var(--c-theme)]
          text-[var(--c-theme)]
          bg-[var(--c-0)]
          dark:bg-[var(--c-0)]
          dark:drop-shadow-none
          hover:bg-[var(--c-theme)]
          hover:text-[var(--c-0)]
          dark:hover:text-[var(--c-10)]
          dark:hover:bg-[var(--c-theme)]
        ">
        test-time-learning
      </a>
    
      <a href="/tags/online-learning/" 
        class="
          tag
          text-sm
          rounded-full
          px-[5px]
          border-[1px]
          border-[var(--c-theme)]
          text-[var(--c-theme)]
          bg-[var(--c-0)]
          dark:bg-[var(--c-0)]
          dark:drop-shadow-none
          hover:bg-[var(--c-theme)]
          hover:text-[var(--c-0)]
          dark:hover:text-[var(--c-10)]
          dark:hover:bg-[var(--c-theme)]
        ">
        online-learning
      </a>
    
  
</div>
      </div>
    </div>
  </header>
  <!-- content -->
  <article class="post-content prose m-auto dark:prose-invert">
    <p>This blog post is part 1 of a series that describes my attempt in implementing the Test-Time Training (TTT) model proposed by <a target="_blank" rel="noopener" href="https://arxiv.org/abs/2407.04620">Sun et al. (2024)</a>, and Titans, proposed by <a target="_blank" rel="noopener" href="https://arxiv.org/abs/2501.00663">Behrouz et al., (2024)</a>. At the time of writing, these two are two strong recurrent language models, but they have not yet open-sourced their implementation (TTT has only open-sourced the Jax implementation).</p>
<span id="more"></span>
<h2 id="Introduction-to-Test-Time-Training">Introduction to Test-Time Training</h2>
<p>Briefly explained, Test-Time Training (TTT) is an RNN model whose hidden state is replaced with an online learner, whose parameters are updated updated through gradient descent during inference. The goal is that this online learner compress contextual information into its parameters. A TTT operator can be expressed as:</p>
<p>$$
\begin{align*}
\mathbf W_t &amp;= f_\text{update}(k_t, v_t, \mathbf W_{t-1}) \\
y_t         &amp;= f_\text{query}(q_t, \mathbf W_t) \in \mathbb R ^d
\end{align*}
$$</p>
<p>where $q_t, k_t, v_t\in\mathbb R^{d}$ are the query, key, and value vectors at time $t$, respectively, $\mathbf W_t$ is the recurrent state <em>and</em> the parameters of an online learner. $d$ is a hyperparameter. The function $f_\text{update}$ is the "update rule", and $f_\text{query}$ is the "query rule".</p>
<h3 id="The-Update-Rule">The Update Rule</h3>
<p>The interesting part is that the update rule is implemented with gradient descent:</p>
<p>$$
\mathbf W_t = \mathbf W_{t-1} - \eta_t \frac{\ell(k_t, v_t, \mathbf W_{t-1})}{ \partial \mathbf W_{t-1} } \\
$$</p>
<p>where the loss is defined as:</p>
<p>$$
\ell(k_t,v_t,\mathbf W_{t-1}) = \frac 1 2 \Vert f_\text{query}(k_t, \mathbf W_{t-1}) - v_t \Vert ^2_2
$$</p>
<p>In other words, the online learner is learning to produce the value vector $v_t$ when we query it with the key vector $k_t$.</p>
<h3 id="Mini-Batch-Gradient-Descent">Mini-Batch Gradient Descent</h3>
<p>Obviously, directly running this algorithm is extremely slow because it cannot be parallellized. Sun et al. (2024) proposed <em>mini-batch gradient descent</em>, in which the input sequence is split into mini-batches and the gradients are computed based on the online learner's state at the start on mini-batch $\mathbf W_{t'}, t=\text{mod}(t, b)$:</p>
<p>$$
\ell_t = \frac 1 2\Vert f_\text{query}(k_t, \mathbf W_{t'}) - v_t\Vert ^2_2
$$</p>
<p>$$
\mathbf W_t = \mathbf W_{t'} - \eta \sum_{s=t'}^{t} \frac{\partial \ell_s}{\partial \mathbf W_{t'}}
$$</p>
<h3 id="Dual-Form">Dual Form</h3>
<p>In order to make make use of matmuls and avoid the materialization of gradients, TTT further proposes to use a "dual form". Without loss of generality, we consider a single mini-batch, where $\mathbf W_0$ is the initial state of the online learner.</p>
<h3 id="Dual-Form-of-Linear-Model">Dual Form of Linear Model</h3>
<p>For simplicity, we first explain the dual form for a linear model:</p>
<p>$$
\begin{align*}
\ell_t &amp;= \frac 1 2 \Vert \mathbf W_0 k_t - v_t \Vert _2 ^2 \\
\mathbf G_t &amp;= \frac{\partial \ell_t}{\partial \mathbf W_0} = (\hat v_t - v_t)k_t^T \\
\mathbf W_t &amp;= \mathbf W_0 - \eta_t \mathbf G_t
\end{align*}
$$</p>
<p>where $\hat v_t=\mathbf W_0 k_t$. We now add in the query vectors and make use of associativity of matrix multiplication to directly compute the output:</p>
<p>$$
\begin{align*}
y_t &amp;= f_\text{query}(q_t, \mathbf W_t)\\
&amp;= \mathbf W_t q_t \\
&amp;= \left(\mathbf W_0 - \eta \sum_{s=1}^t \mathbf G_s\right) q_t \\
&amp;= \mathbf W_0 q_t - \eta \sum_{s=1}^t (\hat v_s-v_s) k_t^T q_t \\
\end{align*}
$$</p>
<p>Now, let's define the reconstruction error as $e_t=\hat v_t - v_t$ and $\mathbf E=[e_1, \dots, e_b]$, $\mathbf K=[k_1, \dots, k_b]$, $\mathbf Q=[q_1, \dots, q_b]$. Then we have:</p>
<p>$$
\begin{align*}
\mathbf Y = \mathbf W_0 \mathbf Q - \eta \mathbf E \left(\mathbf M \odot \mathbf K^T \mathbf Q\right) \in \mathbb R^{d\times b}\\
\end{align*}
$$</p>
<p>where $\mathbf Y\in\mathbb R^{d\times b}$ is the output matrix, $\mathbf Q, \mathbf K, \mathbf V\in\mathbb R^{d\times b}$ are the query, key, and value matrices, $\mathbf M\in\mathbb R^{b\times b}$ is a mask matrix (upper triangular matrix), and $\odot$ is the element-wise product. We also need the state at the end of the batch, which is simply:</p>
<p>$$
\mathbf W_b = \mathbf W_0 - \eta \mathbf E \mathbf K^T
$$</p>
<blockquote>
<p>It's interesting to see how similar this is to ordinary causal linear attention.</p>
</blockquote>
<p>So, to sum up, the dual form of TTT accepts a batch of queries, keys, and values, and online learner state $\left(\mathbf Q, \mathbf K, \mathbf V, \mathbf W\right)$, and returns the output matrix and the state at the end of the batch $\left(\mathbf Y, \mathbf W\right)$. The state at the end of the batch is then used as the initial state for the next batch.</p>
<h3 id="Dual-Form-of-MLP">Dual Form of MLP</h3>
<p>The dual form can be extended to a two-layer MLP. The idea is to first apply the dual form to the first layer to get the intermediate representation, and then apply the dual form to the second layer to get the output. The forward pass can be implemented as:</p>
<p>$$
\hat{\mathbf V} = \mathbf K + \mathbf W_2 \cdot \text{ReLU}\left(\mathbf W_1\cdot \mathbf K\right)
$$</p>
<p>Then the gradients are:</p>
<p>$$
\begin{align*}
\mathbf G_{2,t} &amp;= \left(\hat v_i - v_i\right) \cdot \mathbf h^T_i \in \mathbb R^{d\times d_m} \\
\mathbf G_{1,t}
&amp;= \frac{\partial \ell_t}{\partial \mathbf W_1} \\
&amp;= \frac{\partial \ell_t}{\partial  h_t} \cdot \frac{\partial h_t}{\partial \mathbf W_1} \\
&amp;= \mathbf W_{2,0}^T \left(\hat{v}_t -  v_t\right) \cdot \text{ReLU}'(h_t)\cdot k^T
\end{align*}
$$</p>
<p>Define $g_{h,t}=\mathbf W_{2,0}^T \left(\hat{v}_t -  v_t\right) \cdot \text{ReLU}'(h_t)$, then we can apply dual form the first layer:</p>
<p>$$
\begin{align*}
\mathbf W_{1,t} &amp;= \mathbf W_{1,0} - \eta \sum_{i=1}^t \mathbf G_{1,i}\\
&amp;= \mathbf W_{1,0} - \eta \sum_{i=1}^t g_{h,i}  k^T\\
\Rightarrow \bar h_t &amp;= \mathbf W_{1,t} q_t \\
&amp;= \mathbf W_{1,0} q_t - \eta \sum_{i=1}^t g_{h,i} k^T q_t\\
\Rightarrow \bar{\mathbf H} &amp;= \mathbf W_{1,0} \mathbf Q - \eta \mathbf G_{h} \left(\mathbf M \odot \mathbf K^T \mathbf Q\right) \in \mathbb R^{d_m\times b}
\end{align*}
$$
where $\bar{\mathbf H}$ is the intermediate representation when querying the updated state. Since this is the input query for the second layer, we can apply the dual form to the second layer as if it were a linear model:</p>
<p>$$
\begin{align*}
\mathbf Y &amp;= \mathbf W_{2,0} \bar{\mathbf H} - \eta \mathbf E \left(\mathbf M \odot\mathbf H^T \bar{\mathbf H}\right) \in \mathbb R^{d\times b}
\end{align*}
$$</p>
<p>The state at the end of the batch should be trivial to compute.</p>
<h2 id="Code-Implementation">Code Implementation</h2>
<h3 id="Existing-Open-Source-Implementation">Existing Open-Source Implementation</h3>
<p>I have found an excellent <a target="_blank" rel="noopener" href="https://github.com/lucidrains/titans-pytorch">PyTorch implementation of Titans by lucidrains</a>. Titans is an extension of TTT that adds in momentum-based learning and data-depdendent weight decay and learning rate. However, in this implementation, the memory query is performed on the memory at the start of the batch:
$$
y_t = f_\text{query}(q_t, \mathbf W_{t'})
$$
instead of querying the state after KV insertion $\mathbf W_t$. Not only does this make the implementation much simpler and faster, it also allows for the use of PyTorch's autograd engine (specifically the <code>grad</code> and <code>functional_call</code> functions) to avoid explicitly writing the gradient computation.</p>
<p>However, this is still not exactly the same as the TTT. So, I will try to implement the original TTT model.</p>
<h3 id="My-Implementation">My Implementation</h3>
<p>It should be pretty straightforward to implement the dual form for a two-layer MLP, which is what I will do. Assume that the online learner is defined as:</p>
<p>$$
f_\text{query}(q, \mathbf W) = q + \mathbf W_2 \cdot \text{ReLU}\left(\mathbf W_1\cdot  q \right)
$$</p>
<p>The forward pass can be implemented as:</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">two_layer_mlp_dual_form</span>(<span class="params"></span></span><br><span class="line"><span class="params">    q: Tensor,</span></span><br><span class="line"><span class="params">    k: Tensor,</span></span><br><span class="line"><span class="params">    v: Tensor,</span></span><br><span class="line"><span class="params">    weights: <span class="built_in">dict</span>[<span class="built_in">str</span>, Tensor] | <span class="literal">None</span> = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">tuple</span>[<span class="built_in">dict</span>[<span class="built_in">str</span>, Tensor], Tensor]:</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    This operator utilizes the dual form of TTT (https://arxiv.org/pdf/2407.04620)</span></span><br><span class="line"><span class="string">    to avoid materializing the gradients.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    device = q.device</span><br><span class="line">    batch_size = q.shape[<span class="number">0</span>]</span><br><span class="line">    w1 = weights[<span class="string">"w1"</span>]</span><br><span class="line">    w2 = weights[<span class="string">"w2"</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># forward pass</span></span><br><span class="line">    h = einsum(w1, k, <span class="string">"dm d, b d -&gt; b dm"</span>)  <span class="comment"># (b, dh)</span></span><br><span class="line">    h_relu = torch.relu(h)  <span class="comment"># (b, dh)</span></span><br><span class="line">    h2 = einsum(w2, h_relu, <span class="string">"d dm, b dm -&gt; b d"</span>)</span><br><span class="line">    pred = h2 + k  <span class="comment"># (b, d)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Backward pass</span></span><br><span class="line">    <span class="comment"># We first compute the gradients w.r.t. to the activations,</span></span><br><span class="line">    <span class="comment"># which can be efficiently computed because they utilize</span></span><br><span class="line">    <span class="comment"># backward matmuls.</span></span><br><span class="line">    grad = pred - v  <span class="comment"># (b, d)</span></span><br><span class="line">    grad_h2 = einsum(w2, grad, <span class="string">"dy dh, b dy -&gt; b dh"</span>)</span><br><span class="line">    grad_h = grad_h2 * (h_relu &gt; <span class="number">0</span>).<span class="built_in">float</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Then, we avoid materializing the gradients w.r.t. the two linear layers</span></span><br><span class="line">    <span class="comment"># W1 and W2, by associativity with the queries.</span></span><br><span class="line">    mask = torch.triu(</span><br><span class="line">        torch.ones(batch_size, batch_size, requires_grad=<span class="literal">False</span>, device=device),</span><br><span class="line">    )</span><br><span class="line">    attn_scores = einsum(k, q, <span class="string">'bk dk, bq dk -&gt; bk bq'</span>)  <span class="comment"># (b, b)</span></span><br><span class="line">    attn_scores = attn_scores * mask  <span class="comment"># (b, b)</span></span><br><span class="line">    h_q = einsum(w1, q, <span class="string">'dm d, b d -&gt; b dm'</span>)</span><br><span class="line">    h_q = h_q - einsum(grad_h, attn_scores, <span class="string">'bk dm, bk bq -&gt; bq dm'</span>)</span><br><span class="line">    h2_q = torch.relu(h_q)  <span class="comment"># (b, dm)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Compute the output</span></span><br><span class="line">    attn_scores = einsum(h_relu, h2_q, <span class="string">'bk dm, bq dm -&gt; bk bq'</span>)</span><br><span class="line">    attn_scores = attn_scores * mask</span><br><span class="line">    y = einsum(w2, h2_q, <span class="string">'d dm, b dm -&gt; b d'</span>)</span><br><span class="line">    y = y - einsum(grad, attn_scores, <span class="string">'bk d, bk bq -&gt; bq d'</span>)</span><br><span class="line">    y = y + q  <span class="comment"># Residual connection</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Compute the weights at the end of the batch</span></span><br><span class="line">    grad_w1 = einsum(grad_h, k, <span class="string">"b dh, b dx -&gt; dh dx"</span>)</span><br><span class="line">    w1 = w1 - grad_w1</span><br><span class="line">    grad_w2 = einsum(grad, h_relu, <span class="string">"b dy, b dh -&gt; dy dh"</span>)</span><br><span class="line">    w2 = w2 - grad_w2</span><br><span class="line">    weights = {</span><br><span class="line">        <span class="string">'w1'</span>: w1,</span><br><span class="line">        <span class="string">'w2'</span>: w2,</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> y, weights</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h2 id="How-to-Cite">How to Cite</h2>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@misc{chen2025ttt-implementation,</span><br><span class="line">    author = {Yingfa Chen},</span><br><span class="line">    title = {Implementating Test-Time Training - Part 1},</span><br><span class="line">    year = {2025},</span><br><span class="line">    url = {https://chen-yingfa.github.io/2025/03/19/ttt-implementation/},</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<hr>
<p>Author: Yingfa Chen</p>
<h1>References</h1>
<ul>
<li>Test-Time Training. 2024. <a target="_blank" rel="noopener" href="https://arxiv.org/abs/2407.04620">https://arxiv.org/abs/2407.04620</a>.</li>
<li>Titans. 2024. <a target="_blank" rel="noopener" href="https://arxiv.org/abs/2501.00663">https://arxiv.org/abs/2501.00663</a>.</li>
<li>PyTorch Implementation of Titans by lucidrains. <a target="_blank" rel="noopener" href="https://github.com/lucidrains/titans-pytorch">https://github.com/lucidrains/titans-pytorch</a>.</li>
</ul>

  </article>

  <!-- prev and next -->
  <div class="flex justify-between mt-4 pt-4
    border-t border-[var(--c-sep)] text-sm
    gap-2 text-[var(--c-50)]
  ">
    <div>
      
        <a href="/2025/03/22/2025%E5%AF%92%E5%81%87%E4%B9%8B%E5%90%8E/"
          class="
            transition-all
            flex justify-center
            hover:-translate-x-1
            hover:text-[var(--c-80)]
          ">
          <iconify-icon width="20" icon="mingcute:left-fill" data-inline="false">
          </iconify-icon>
          寒假之后.md
        </a>
      
    </div>
    <div>
      
        <a href="/2024/12/03/2024-%E7%AD%89%E5%AE%BD%E5%AD%97%E4%BD%93/"
          class="
            flex 
            justify-center
            hover:translate-x-1 
            transition-transform
            hover:text-[var(--c-100)]
          "
        >
          VS Code 等宽字体的问题
          <iconify-icon width="20" icon="mingcute:right-fill" data-inline="false"></iconify-icon>
        </a>
      
    </div>
  </div>

  <!-- comment -->
  <div class="article-comments mt-12">
    

  </div>
</section>
<!-- js inspect -->

<script src="/lib/clipboard.min.js"></script>


<script async src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": {
        preferredFont: "TeX",
        availableFonts: ["STIX","TeX"],
        linebreaks: { automatic:true },
        EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
        inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
        processEscapes: true,
        ignoreClass: "tex2jax_ignore|dno",
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
        equationNumbers: { autoNumber: "AMS" },
        noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } },
        Macros: { href: "{}" }
    },
    messageStyle: "none"
  });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>



<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
  $(document).ready(() => {
    const maraidConfig = {
      theme: "default",
      logLevel: 3,
      flowchart: { curve: "linear" },
      gantt: { axisFormat: "%m/%d/%Y" },
      sequence: { actorMargin: 50 },
    };
    mermaid.initialize(maraidConfig);
  });
</script>



<script src="/lib/fancybox/fancybox.umd.min.js"></script>

<script>
  $(document).ready(() => {
    $('.post-content').each(function(i){
      $(this).find('img').each(function(){
        if ($(this).parent().hasClass('fancybox') || $(this).parent().is('a')) return;
        var alt = this.alt;
        var title = this.title;
        if (alt) $(this).after('<span class="fancybox-alt">' + alt + '</span>');
        else if (title) $(this).after('<span class="fancybox-title">' + title + '</span>');
        $(this).wrap('<a class="fancybox-img" href="' + this.src + '" data-fancybox=\"gallery\" data-caption="' + title + '"></a>')
      });
      $(this).find('.fancybox').each(function(){
        $(this).attr('rel', 'article' + i);
      });
    });

    Fancybox.bind('[data-fancybox="gallery"]', {
        // options
    })
  })
</script>

<!-- tocbot begin -->

<script src="/lib/tocbot/tocbot.min.js"></script>

<script>
  $(document).ready(() => {
      tocbot.init({
        // Where to render the table of contents.
        tocSelector: '.post-toc',
        // Where to grab the headings to build the table of contents.
        contentSelector: '.post-content',
        // Which headings to grab inside of the contentSelector element.
        headingSelector: 'h1, h2, h3',
        // For headings inside relative or absolute positioned containers within content.
        hasInnerContainers: true,
    });
  })
</script>
<!-- tocbot end -->

  </main>
  <footer class="flex flex-col mt-18 mb-12 items-center
  text-[var(--c-50)] text-sm">
  <div class="flex flex-row items-center my-12">
    
    
        
        
            
            
        
        <a class="
            hover:text-[var(--c-theme)]
            hover:bg-[var(--c-20)]
            rounded-lg
            p-2
            my-1
            flex flex-row items-center
            group" title="Github" target="_blank" rel="noopener" href="https://www.github.com/chen-yingfa">
            <iconify-icon width="28" icon="mingcute:github-fill"></iconify-icon>
        </a>
    
        
        
            
            
        
        <a class="
            hover:text-[var(--c-theme)]
            hover:bg-[var(--c-20)]
            rounded-lg
            p-2
            my-1
            flex flex-row items-center
            group" title="ZhiHu" target="_blank" rel="noopener" href="https://www.zhihu.com/people/chen-ying-fa-34">
            <iconify-icon width="28" icon="ri:zhihu-line"></iconify-icon>
        </a>
    
        
        
            
            
        
        <a class="
            hover:text-[var(--c-theme)]
            hover:bg-[var(--c-20)]
            rounded-lg
            p-2
            my-1
            flex flex-row items-center
            group" title="Twitter" target="_blank" rel="noopener" href="https://www.twitter.com/yingfachen">
            <iconify-icon width="28" icon="mingcute:social-x-fill"></iconify-icon>
        </a>
    
        
        
            
            
        
        <a class="
            hover:text-[var(--c-theme)]
            hover:bg-[var(--c-20)]
            rounded-lg
            p-2
            my-1
            flex flex-row items-center
            group" title="google_scholar" target="_blank" rel="noopener" href="https://scholar.google.com/citations?user=IgPWvEQAAAAJ&amp;hl=en">
            <iconify-icon width="28" icon="mingcute:mortarboard-fill"></iconify-icon>
        </a>
    

  </div>
  <!-- busuanzi -->
  <div class="mb-6">
    
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!-- Busuanzi Analytics -->
<div class="flex flex-col items-center mb-2">
  <div class="flex flex-row items-center">
    <iconify-icon width="16" icon="ic:round-person" width="18"></iconify-icon>
    <span class="mr-1">访客 Visitors: </span>
    <span id="busuanzi_value_site_uv"></span>
  </div>
  <div class="flex flex-row items-center">
    <iconify-icon width="16" icon="carbon:view-filled" width="18"></iconify-icon>
    <span class="mx-1">浏览量 Page Views:</span>
    <span id="busuanzi_value_site_pv"></span>
  </div>
</div>
<!-- End Busuanzi Analytics -->


  </div>
  <!-- copyright -->
  <div class="flex flex-row items-center gap-2">
    <a class="hover:underline"
      target="_blank"
      href="https://creativecommons.org/licenses/by-nc-sa/4.0/"
    >
      CC BY-NC-SA 4.0
    </a>
    <span>© 2022-2024</span>
    <a class="hover:underline"
    href="https://github.com/chen-yingfa" 
    target="_blank" 
    rel="noopener noreferrer">陈英发</a>
  </div>
  <!-- powered by -->
  <div class="flex items-center gap-1">
    <span>Powered by</span>
    <a class="hover:underline" 
    href="https://hexo.io/" target="_blank" rel="noopener noreferrer">Hexo</a>
    <span>&</span>
    <a href="https://github.com/chen-yingfa/hexo-theme-fengye" 
    class="hover:underline"
    target="_blank"
      rel="noopener noreferrer"
      >
      枫叶 Fengye
    </a>
  </div>

</footer>

  <div class="
    back-to-top
    fixed right-6
    z-1024
    -bottom-20
    rounded-lg
    font-bold
    py-1 px-2
    text-[var(--c-80)]
    bg-[var(--c-20)]
    cursor-pointer
    text-center
    drop-shadow-md
  ">
    <span class="flex justify-center items-center text-sm">
      <span id="scrollpercent"><span>0</span> %</span>
      <iconify-icon width="18" icon="mingcute:arrow-to-up-fill" id="go-top"></iconify-icon>
    </span>
  </div>
  
<script src="/js/main.js"></script>


  <div class="fixed top-0 bottom-0 left-0 right-0 pointer-events-none print:hidden" id="maple"></div>
</body>

</html>
